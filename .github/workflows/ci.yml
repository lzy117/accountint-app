# 工作流名称
name: Python Accounting App CI

# 触发工作流的事件
on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

# 工作流包含的任务
jobs:
  build-and-test:
    # 运行此任务的操作系统环境
    runs-on: ubuntu-latest
    
    # 策略：测试多个 Python 版本
    # 注意：3.14 是较新版本，如果 Actions 不支持可移除
    strategy:
      fail-fast: false  # 即使某个版本失败也继续运行其他版本
      matrix:
        python-version: ['3.10', '3.11', '3.12', '3.14']
    
    steps:
    # 第一步：检出代码库
    - name: Checkout repository
      uses: actions/checkout@v4
    
    # 第二步：设置 Python 环境
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
    
    # 第三步：安装项目依赖
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-cov
    
    # 第四步：运行单元测试
    - name: Run unit tests with pytest
      run: |
        cd project
        python -m pytest tests/test_record_manager.py tests/test_ocr_service.py -v --tb=short
    
    # 第五步：运行集成测试
    - name: Run integration tests
      run: |
        cd project
        python -m pytest tests/test_integration.py -v --tb=short
    
    # 第六步：运行测试并生成覆盖率报告
    - name: Run tests with coverage
      run: |
        cd project
        python -m pytest tests/test_record_manager.py tests/test_ocr_service.py --cov=logic --cov-report=term-missing --cov-fail-under=80
    
    # 第七步：上传测试结果（可选）
    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results-${{ matrix.python-version }}
        path: project/tests/
        retention-days: 7
